{% extends "base.html" %}

{% block title %}Create Order - CloudBite{% endblock %}

{% block content %}
<h1 style="color: #2c3e50; margin-bottom: 2rem;">Create Your Order</h1>

<div style="background: white; padding: 2rem; border-radius: 10px;">
    <form id="orderForm" method="POST" action="{{ url_for('orders.create_order') }}">
        <div id="orderItems" style="margin-bottom: 2rem;">
            <h3 style="color: #2c3e50; margin-bottom: 1rem;">Order Items</h3>
            
            <div class="order-item" style="border: 1px solid #ddd; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: center;">
                    <input type="text" name="item_name[]" placeholder="Item name" required
                           style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <input type="number" name="item_price[]" placeholder="Price" step="0.01" required
                           style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <input type="number" name="item_quantity[]" placeholder="Qty" value="1" min="1" required
                           style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <button type="button" class="remove-item" style="background: #e74c3c; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">Remove</button>
                </div>
            </div>
        </div>
        
        <button type="button" id="addItem" class="btn btn-secondary" style="margin-bottom: 1rem;">
            + Add Another Item
        </button>
        
        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #ddd;">
            <p style="font-size: 1.3rem; font-weight: bold; color: #27ae60; text-align: right;">
                Total: $<span id="totalAmount">0.00</span>
            </p>
        </div>
        
        <button type="submit" class="btn" style="width: 100%; padding: 15px; font-size: 1.1rem; margin-top: 1rem;">
            Place Order
        </button>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const orderItemsContainer = document.getElementById('orderItems');
    const addItemBtn = document.getElementById('addItem');
    const orderForm = document.getElementById('orderForm');
    
    // Add new item
    addItemBtn.addEventListener('click', function() {
        const newItem = document.createElement('div');
        newItem.className = 'order-item';
        newItem.style.cssText = 'border: 1px solid #ddd; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;';
        newItem.innerHTML = `
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: center;">
                <input type="text" name="item_name[]" placeholder="Item name" required
                       style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <input type="number" name="item_price[]" placeholder="Price" step="0.01" required
                       style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <input type="number" name="item_quantity[]" placeholder="Qty" value="1" min="1" required
                       style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <button type="button" class="remove-item" style="background: #e74c3c; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">Remove</button>
            </div>
        `;
        orderItemsContainer.appendChild(newItem);
        calculateTotal();
    });
    
    // Remove item
    orderItemsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item')) {
            const items = orderItemsContainer.querySelectorAll('.order-item');
            if (items.length > 1) {
                e.target.closest('.order-item').remove();
                calculateTotal();
            } else {
                alert('You must have at least one item in your order');
            }
        }
    });
    
    // Calculate total on input change
    orderItemsContainer.addEventListener('input', calculateTotal);
    
    function calculateTotal() {
        let total = 0;
        const items = orderItemsContainer.querySelectorAll('.order-item');
        items.forEach(item => {
            const price = parseFloat(item.querySelector('input[name="item_price[]"]').value) || 0;
            const quantity = parseInt(item.querySelector('input[name="item_quantity[]"]').value) || 0;
            total += price * quantity;
        });
        document.getElementById('totalAmount').textContent = total.toFixed(2);
    }
    
    // Form submission
    orderForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(orderForm);
        const names = formData.getAll('item_name[]');
        const prices = formData.getAll('item_price[]');
        const quantities = formData.getAll('item_quantity[]');
        
        const items = [];
        for (let i = 0; i < names.length; i++) {
            items.push({
                name: names[i],
                price: parseFloat(prices[i]),
                quantity: parseInt(quantities[i])
            });
        }
        
        fetch('{{ url_for("orders.create_order") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ items: items })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{{ url_for("orders.order_list") }}';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to create order');
        });
    });
    
    // Initial calculation
    calculateTotal();
});
</script>
{% endblock %}